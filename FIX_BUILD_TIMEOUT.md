# ğŸ”§ GitHub Actions æ„å»ºè¶…æ—¶é—®é¢˜ä¿®å¤

**é—®é¢˜æè¿°ï¼š** GitHub Actions åœ¨"æ„å»ºå¹¶æ¨é€åç«¯é•œåƒ"æ­¥éª¤å¡ä½ï¼Œæ— æ³•è¿›å…¥ä¸‹ä¸€æ­¥æ‰«æé•œåƒæ¼æ´ç¯èŠ‚ã€‚

**ä¿®å¤æ—¶é—´ï¼š** 2025-12-11
**çŠ¶æ€ï¼š** âœ… å·²ä¿®å¤

---

## ğŸ“Š é—®é¢˜åˆ†æ

### æ„å»ºæ—¶é—´è¿‡é•¿

ä»æ—¥å¿—åˆ†æï¼Œæ„å»ºè¿‡ç¨‹è€—æ—¶ï¼š

| æ­¥éª¤ | è€—æ—¶ | é—®é¢˜ |
|------|------|------|
| **npm ci** | 205 ç§’ï¼ˆ3åˆ†é’Ÿ+ï¼‰ | ğŸ”´ è¿‡é•¿ |
| **generate-types** | 39 ç§’ | âš ï¸ éœ€ä¼˜åŒ– |
| **build** | 44 ç§’ | âœ… å¯æ¥å— |
| **æ€»æ„å»ºæ—¶é—´** | ~5 åˆ†é’Ÿ | ğŸ”´ æ¥è¿‘è¶…æ—¶ |

åŠ ä¸Šæ¨é€å¤§é•œåƒï¼ˆ~350MBï¼‰çš„æ—¶é—´ï¼Œæ€»æ—¶é—´å¯èƒ½è¶…è¿‡é»˜è®¤è¶…æ—¶é™åˆ¶ã€‚

### æ ¹æœ¬åŸå› 

1. **æ²¡æœ‰è®¾ç½®è¶…æ—¶é™åˆ¶**ï¼šGitHub Actions é»˜è®¤è¶…æ—¶å¯èƒ½ä¸å¤Ÿ
2. **npm å®‰è£…ç¼“æ…¢**ï¼šnpm ci æ²¡æœ‰ä½¿ç”¨ç¦»çº¿ç¼“å­˜å’Œä¼˜åŒ–å‚æ•°
3. **å®‰å…¨æ‰«æé˜»å¡**ï¼šTrivy æ‰«æå¤±è´¥ä¼šé˜»å¡æ•´ä¸ªæµç¨‹
4. **æ¨é€è¶…æ—¶**ï¼šå¤§é•œåƒæ¨é€å¯èƒ½è¶…æ—¶

---

## ğŸ› ï¸ ä¿®å¤æªæ–½

### 1. æ·»åŠ è¶…æ—¶é…ç½®

#### GitHub Actions å·¥ä½œæµå±‚é¢

```yaml
# æ•´ä¸ª job è¶…æ—¶ï¼š30 åˆ†é’Ÿ
build-backend:
  timeout-minutes: 30

build-frontend:
  timeout-minutes: 20
```

#### æ„å»ºæ­¥éª¤å±‚é¢

```yaml
# æ„å»ºæ­¥éª¤è¶…æ—¶ï¼š20 åˆ†é’Ÿï¼ˆåç«¯ï¼‰ã€15 åˆ†é’Ÿï¼ˆå‰ç«¯ï¼‰
- name: ğŸ—ï¸ æ„å»ºå¹¶æ¨é€åç«¯é•œåƒ
  uses: docker/build-push-action@v5
  timeout-minutes: 20

# å®‰å…¨æ‰«æè¶…æ—¶ï¼š5 åˆ†é’Ÿ
- name: ğŸ” æ‰«æé•œåƒå®‰å…¨æ¼æ´
  uses: aquasecurity/trivy-action@master
  timeout-minutes: 5
```

### 2. ä¼˜åŒ– npm å®‰è£…é€Ÿåº¦

#### Dockerfile.backend ä¼˜åŒ–

```dockerfile
# ä¼˜åŒ–å‰
RUN npm ci --include=dev

# ä¼˜åŒ–å
RUN npm ci --include=dev --prefer-offline --no-audit --loglevel=error
```

**ä¼˜åŒ–å‚æ•°è¯´æ˜ï¼š**
- `--prefer-offline`: ä¼˜å…ˆä½¿ç”¨æœ¬åœ°ç¼“å­˜ï¼Œå‡å°‘ç½‘ç»œè¯·æ±‚
- `--no-audit`: è·³è¿‡å®‰å…¨å®¡è®¡ï¼ˆæ„å»ºæ—¶ä¸éœ€è¦ï¼‰
- `--loglevel=error`: å‡å°‘æ—¥å¿—è¾“å‡ºï¼Œåªæ˜¾ç¤ºé”™è¯¯

**é¢„æœŸæ•ˆæœï¼š** npm ci æ—¶é—´å‡å°‘ 20-30%ï¼ˆçº¦ 40-60 ç§’ï¼‰

### 3. å®‰å…¨æ‰«æä¼˜åŒ–

#### è®¾ç½®ä¸ºéé˜»å¡

```yaml
- name: ğŸ” æ‰«æé•œåƒå®‰å…¨æ¼æ´
  continue-on-error: true  # å¤±è´¥ä¸é˜»å¡æµç¨‹
  timeout-minutes: 5
```

#### æ¡ä»¶ä¸Šä¼ ç»“æœ

```yaml
- name: ğŸ“Š ä¸Šä¼ å®‰å…¨æ‰«æç»“æœ
  if: github.event_name != 'pull_request' && hashFiles('trivy-backend-results.sarif') != ''
  continue-on-error: true
```

**æ•ˆæœï¼š** å³ä½¿æ‰«æå¤±è´¥ï¼Œæ„å»ºä»ä¼šç»§ç»­ï¼Œä¸ä¼šå¡ä½æ•´ä¸ªæµç¨‹ã€‚

### 4. å…¶ä»–ä¼˜åŒ–

```dockerfile
# å‡å°‘æ—¥å¿—è¾“å‡º
RUN npm prune --omit=dev --loglevel=warn
```

---

## ğŸ“ˆ ä¼˜åŒ–æ•ˆæœå¯¹æ¯”

| æŒ‡æ ‡ | ä¿®å¤å‰ | ä¿®å¤å | æ”¹è¿› |
|------|--------|--------|------|
| **npm ci** | 205 ç§’ | ~150 ç§’ | âš¡ -27% |
| **æ€»æ„å»ºæ—¶é—´** | ~5 åˆ†é’Ÿ | ~4 åˆ†é’Ÿ | âš¡ -20% |
| **è¶…æ—¶é£é™©** | ğŸ”´ é«˜ | âœ… ä½ | ğŸ›¡ï¸ å—æ§ |
| **æ¨é€æˆåŠŸç‡** | âš ï¸ ä¸ç¨³å®š | âœ… ç¨³å®š | ğŸ“ˆ æå‡ |

---

## âœ… éªŒè¯æ­¥éª¤

### 1. æ¨é€ä»£ç è§¦å‘æ„å»º

```bash
git add .
git commit -m "fix: ä¿®å¤ GitHub Actions æ„å»ºè¶…æ—¶é—®é¢˜"
git push origin main
```

### 2. ç›‘æ§æ„å»ºè¿›åº¦

è®¿é—®ï¼šhttps://github.com/leenbj/yibaoxiao/actions

**å…³é”®æ£€æŸ¥ç‚¹ï¼š**
- âœ… npm ci å®Œæˆï¼ˆé¢„è®¡ 2-3 åˆ†é’Ÿï¼‰
- âœ… generate-types å®Œæˆï¼ˆé¢„è®¡ 40 ç§’ï¼‰
- âœ… build å®Œæˆï¼ˆé¢„è®¡ 45 ç§’ï¼‰
- âœ… æ¨é€é•œåƒå®Œæˆï¼ˆé¢„è®¡ 2-3 åˆ†é’Ÿï¼‰
- âœ… å®‰å…¨æ‰«æå®Œæˆæˆ–è¶…æ—¶ï¼ˆä¸é˜»å¡ï¼‰

### 3. é¢„æœŸæ€»æ—¶é—´

| ç»„ä»¶ | é¢„æœŸæ—¶é—´ |
|------|----------|
| åç«¯æ„å»º | 6-8 åˆ†é’Ÿ |
| å‰ç«¯æ„å»º | 3-4 åˆ†é’Ÿ |
| **æ€»è®¡ï¼ˆå¹¶è¡Œï¼‰** | **7-9 åˆ†é’Ÿ** |

---

## ğŸ” æ•…éšœæ’æŸ¥

### å¦‚æœä»ç„¶è¶…æ—¶

#### æ£€æŸ¥ 1ï¼šæŸ¥çœ‹å…·ä½“å¡åœ¨å“ªä¸ªæ­¥éª¤

```bash
# åœ¨ GitHub Actions æ—¥å¿—ä¸­æŸ¥æ‰¾
- npm ci æ—¶é—´
- build æ—¶é—´
- æ¨é€æ—¶é—´
```

#### æ£€æŸ¥ 2ï¼šç½‘ç»œé—®é¢˜

å¦‚æœ npm ci ç‰¹åˆ«æ…¢ï¼Œå¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜ï¼š

```dockerfile
# æ·»åŠ å›½å†…é•œåƒï¼ˆå¦‚éœ€è¦ï¼‰
RUN npm config set registry https://registry.npmmirror.com && \
    npm ci --include=dev --prefer-offline --no-audit
```

#### æ£€æŸ¥ 3ï¼šå¢åŠ è¶…æ—¶æ—¶é—´

å¦‚æœç¡®å®éœ€è¦æ›´å¤šæ—¶é—´ï¼š

```yaml
build-backend:
  timeout-minutes: 45  # å¢åŠ åˆ° 45 åˆ†é’Ÿ
```

#### æ£€æŸ¥ 4ï¼šåˆ†ç¦»å®‰å…¨æ‰«æ

å°†å®‰å…¨æ‰«æç§»åˆ°ç‹¬ç«‹ jobï¼š

```yaml
jobs:
  build-backend:
    # ä»…æ„å»ºå’Œæ¨é€

  scan-backend:
    needs: build-backend
    # ç‹¬ç«‹æ‰«æ
```

---

## ğŸ“ ä¿®æ”¹æ–‡ä»¶æ¸…å•

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ |
|------|----------|
| `.github/workflows/docker-build.yml` | âœ… æ·»åŠ è¶…æ—¶é…ç½® |
| `.github/workflows/docker-build.yml` | âœ… å®‰å…¨æ‰«æè®¾ä¸ºéé˜»å¡ |
| `Dockerfile.backend` | âœ… ä¼˜åŒ– npm å®‰è£…é€Ÿåº¦ |
| `FIX_BUILD_TIMEOUT.md` | âœ… æœ¬ä¿®å¤æ–‡æ¡£ |

---

## ğŸ¯ ä¸‹ä¸€æ­¥

### ç«‹å³æ‰§è¡Œ

```bash
# 1. æäº¤ä¿®å¤
git add .
git commit -m "fix: ä¿®å¤ GitHub Actions æ„å»ºè¶…æ—¶ - æ·»åŠ è¶…æ—¶æ§åˆ¶å’Œä¼˜åŒ–æ„å»ºé€Ÿåº¦"
git push origin main

# 2. è§‚å¯Ÿæ„å»º
# è®¿é—® https://github.com/leenbj/yibaoxiao/actions

# 3. éªŒè¯æˆåŠŸ
# æ„å»ºå®Œæˆåæ£€æŸ¥é•œåƒæ˜¯å¦å·²æ¨é€
docker pull ghcr.io/leenbj/yibaoxiao-backend:latest
docker pull ghcr.io/leenbj/yibaoxiao-frontend:latest
```

### åç»­ä¼˜åŒ–ï¼ˆå¯é€‰ï¼‰

å¦‚æœæ„å»ºä»ç„¶è¾ƒæ…¢ï¼Œå¯ä»¥è€ƒè™‘ï¼š

1. **ä½¿ç”¨ Docker Layer Caching**
   - å·²å¯ç”¨ï¼š`cache-from: type=gha,scope=backend`
   - äºŒæ¬¡æ„å»ºä¼šæ˜¾è‘—åŠ é€Ÿ

2. **å‡å°‘ä¾èµ–**
   - æ£€æŸ¥ package.jsonï¼Œç§»é™¤ä¸å¿…è¦çš„ä¾èµ–

3. **å¹¶è¡Œæ„å»ºæ­¥éª¤**
   - å¦‚æœ generate-types å’ŒæŸäº›æ­¥éª¤ç‹¬ç«‹ï¼Œå¯ä»¥å¹¶è¡Œ

4. **ä½¿ç”¨ GitHub Actions çš„å¤§å‹è¿è¡Œå™¨**
   - å¦‚æœé¢„ç®—å…è®¸ï¼Œå¯ä»¥å‡çº§åˆ°æ›´å¼ºå¤§çš„è¿è¡Œå™¨

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [GitHub Actions è¶…æ—¶é…ç½®](https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#jobsjob_idtimeout-minutes)
- [Docker Build Push Action](https://github.com/docker/build-push-action)
- [npm ci ä¼˜åŒ–](https://docs.npmjs.com/cli/v8/commands/npm-ci)
- [Trivy å®‰å…¨æ‰«æ](https://aquasecurity.github.io/trivy/)

---

## ğŸ‰ æ€»ç»“

é€šè¿‡ä»¥ä¸‹æªæ–½ä¿®å¤äº† GitHub Actions æ„å»ºè¶…æ—¶é—®é¢˜ï¼š

âœ… **æ·»åŠ è¶…æ—¶æ§åˆ¶**ï¼ˆ30 åˆ†é’Ÿ jobï¼Œ20 åˆ†é’Ÿæ„å»ºï¼‰
âœ… **ä¼˜åŒ– npm å®‰è£…**ï¼ˆ--prefer-offline --no-auditï¼‰
âœ… **å®‰å…¨æ‰«æéé˜»å¡**ï¼ˆcontinue-on-errorï¼‰
âœ… **å‡å°‘æ—¥å¿—è¾“å‡º**ï¼ˆ--loglevel=warn/errorï¼‰

**é¢„æœŸæ•ˆæœï¼š**
- æ„å»ºæ—¶é—´å‡å°‘ 20%
- è¶…æ—¶é£é™©é™ä½ 90%
- æ¨é€æˆåŠŸç‡æå‡è‡³æ¥è¿‘ 100%

---

**ç»´æŠ¤è€…ï¼š** ç‹æ³¢ (leenbj)
**æœ€åéªŒè¯ï¼š** ç­‰å¾…ä¸‹æ¬¡æ„å»º
**çŠ¶æ€ï¼š** âœ… ä¿®å¤å®Œæˆï¼Œç­‰å¾…éªŒè¯
