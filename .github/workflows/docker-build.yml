name: Build and Push Docker Images

# æ˜“æŠ¥é”€ Pro - Docker é•œåƒæž„å»ºå·¥ä½œæµ
# é’ˆå¯¹ 2æ ¸4G ä½Žé…æœåŠ¡å™¨ä¼˜åŒ–çš„ç”Ÿäº§é•œåƒ
#
# è§¦å‘æ¡ä»¶ï¼š
# - æŽ¨é€åˆ° main åˆ†æ”¯
# - åˆ›å»ºç‰ˆæœ¬æ ‡ç­¾ (v*)
# - æ‰‹åŠ¨è§¦å‘

on:
  push:
    branches: [main]
    tags: ['v*']
  workflow_dispatch:
    inputs:
      skip_cache:
        description: 'è·³è¿‡æž„å»ºç¼“å­˜'
        required: false
        default: 'false'
        type: boolean

env:
  REGISTRY: ghcr.io
  BACKEND_IMAGE: ghcr.io/${{ github.repository }}-backend
  FRONTEND_IMAGE: ghcr.io/${{ github.repository }}-frontend

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            image=moby/buildkit:latest
            network=host

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Backend
        id: meta-backend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.BACKEND_IMAGE }}
          tags: |
            type=ref,event=branch
            type=ref,event=tag
            type=sha,prefix=
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Extract metadata for Frontend
        id: meta-frontend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.FRONTEND_IMAGE }}
          tags: |
            type=ref,event=branch
            type=ref,event=tag
            type=sha,prefix=
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Backend image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.backend
          push: true
          tags: ${{ steps.meta-backend.outputs.tags }}
          labels: ${{ steps.meta-backend.outputs.labels }}
          cache-from: ${{ github.event.inputs.skip_cache == 'true' && '' || 'type=gha' }}
          cache-to: type=gha,mode=max
          # å¤šé˜¶æ®µæž„å»ºä¼˜åŒ–å‚æ•°
          build-args: |
            NODE_ENV=production
            NODE_OPTIONS=--max-old-space-size=2048
          # æž„å»ºå¹³å°
          platforms: linux/amd64

      - name: Build and push Frontend image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.frontend
          push: true
          tags: ${{ steps.meta-frontend.outputs.tags }}
          labels: ${{ steps.meta-frontend.outputs.labels }}
          cache-from: ${{ github.event.inputs.skip_cache == 'true' && '' || 'type=gha' }}
          cache-to: type=gha,mode=max
          platforms: linux/amd64

      - name: Summary
        run: |
          echo "## ðŸš€ Docker Images Built Successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ é•œåƒä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Backend Image:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.meta-backend.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Frontend Image:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.meta-frontend.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ¯ æ€§èƒ½ä¼˜åŒ–è¯´æ˜Ž" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "æœ¬æ¬¡æž„å»ºåŒ…å«ä»¥ä¸‹ç”Ÿäº§çŽ¯å¢ƒä¼˜åŒ–ï¼š" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ä½¿ç”¨ \`motia start\` ç”Ÿäº§æ¨¡å¼" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… é¢„ç¼–è¯‘ Motia é¡¹ç›®ï¼Œå‡å°‘è¿è¡Œæ—¶ CPU å ç”¨" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Node.js å†…å­˜é™åˆ¶: 1024MB" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… æ•°æ®åº“è¿žæŽ¥æ± ä¼˜åŒ–ï¼ˆmin:1, max:5ï¼‰" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… å¤šé˜¶æ®µæž„å»ºï¼Œå‡å°‘é•œåƒå¤§å°" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… è‡ªåŠ¨åˆå§‹åŒ–æ•°æ®åº“å’Œè¶…çº§ç®¡ç†å‘˜" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ‘¤ é»˜è®¤ç®¡ç†å‘˜è´¦å·" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| é¡¹ç›® | å€¼ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| é‚®ç®± | \`wangbo@knet.cn\` |" >> $GITHUB_STEP_SUMMARY
          echo "| å¯†ç  | \`123456\` |" >> $GITHUB_STEP_SUMMARY
          echo "| è§’è‰² | è¶…çº§ç®¡ç†å‘˜ |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ éƒ¨ç½²è¯´æ˜Ž" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»¥ä¸‹å‘½ä»¤éƒ¨ç½²ï¼š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# 1. ç™»å½• GitHub Container Registry" >> $GITHUB_STEP_SUMMARY
          echo "echo \$GITHUB_TOKEN | docker login ghcr.io -u USERNAME --password-stdin" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# 2. æ‹‰å–æœ€æ–°é•œåƒ" >> $GITHUB_STEP_SUMMARY
          echo "docker-compose -f docker-compose.prod.yml pull" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# 3. å¯åŠ¨æœåŠ¡" >> $GITHUB_STEP_SUMMARY
          echo "docker-compose -f docker-compose.prod.yml up -d" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# 4. æŸ¥çœ‹æ—¥å¿—" >> $GITHUB_STEP_SUMMARY
          echo "docker-compose -f docker-compose.prod.yml logs -f" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”§ çŽ¯å¢ƒå˜é‡é…ç½®" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "å¯é€šè¿‡ \`.env\` æ–‡ä»¶æˆ–çŽ¯å¢ƒå˜é‡è¦†ç›–é»˜è®¤é…ç½®ï¼š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| å˜é‡ | é»˜è®¤å€¼ | è¯´æ˜Ž |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| ADMIN_EMAIL | wangbo@knet.cn | ç®¡ç†å‘˜é‚®ç®± |" >> $GITHUB_STEP_SUMMARY
          echo "| ADMIN_PASSWORD | 123456 | ç®¡ç†å‘˜å¯†ç  |" >> $GITHUB_STEP_SUMMARY
          echo "| POSTGRES_USER | yibao | æ•°æ®åº“ç”¨æˆ· |" >> $GITHUB_STEP_SUMMARY
          echo "| POSTGRES_PASSWORD | yibao123456 | æ•°æ®åº“å¯†ç  |" >> $GITHUB_STEP_SUMMARY
