# ============================================================
# æ˜“æŠ¥é”€ Pro - Docker é•œåƒæž„å»ºå·¥ä½œæµï¼ˆä¼˜åŒ–ç‰ˆï¼‰
# ============================================================
#
# è§¦å‘æ¡ä»¶ï¼š
#   - æŽ¨é€åˆ° main åˆ†æ”¯
#   - åˆ›å»º tagï¼ˆå¦‚ v1.0.0ï¼‰
#   - Pull Requestï¼ˆä»…æž„å»ºä¸æŽ¨é€ï¼‰
#   - æ‰‹åŠ¨è§¦å‘ï¼ˆworkflow_dispatchï¼‰
#
# ä¼˜åŒ–ç‰¹æ€§ï¼š
#   - å¹¶è¡Œæž„å»ºåŽç«¯å’Œå‰ç«¯
#   - GitHub Actions ç¼“å­˜åŠ é€Ÿ
#   - é•œåƒå®‰å…¨æ‰«æï¼ˆTrivyï¼‰
#   - æž„å»ºæ—¶é—´å’Œå¤§å°æŠ¥å‘Š
#   - å¤šå¹³å°æ”¯æŒï¼ˆamd64/arm64ï¼‰
#
# é•œåƒä»“åº“ï¼šGitHub Container Registry (ghcr.io)
#
# ============================================================

name: ðŸš€ Build and Push Docker Images

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'é•œåƒæ ‡ç­¾ï¼ˆé»˜è®¤: latestï¼‰'
        required: false
        default: 'latest'
      platforms:
        description: 'æž„å»ºå¹³å°ï¼ˆlinux/amd64 æˆ– linux/amd64,linux/arm64ï¼‰'
        required: false
        default: 'linux/amd64'

env:
  # GitHub Container Registry é…ç½®
  REGISTRY: ghcr.io
  # é•œåƒåç§°ï¼ˆè‡ªåŠ¨è½¬å°å†™ï¼‰
  BACKEND_IMAGE: ghcr.io/${{ github.repository_owner }}/yibaoxiao-backend
  FRONTEND_IMAGE: ghcr.io/${{ github.repository_owner }}/yibaoxiao-frontend

jobs:
  # ==================== æž„å»ºåŽç«¯é•œåƒ ====================
  build-backend:
    name: ðŸ”§ æž„å»ºåŽç«¯é•œåƒ
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      security-events: write

    steps:
      - name: ðŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ðŸ”§ è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            image=moby/buildkit:latest
            network=host

      - name: ðŸ” ç™»å½• GitHub Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ·ï¸ æå–é•œåƒå…ƒæ•°æ®
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.BACKEND_IMAGE }}
          tags: |
            type=raw,value=latest,enable={{is_default_branch}}
            type=raw,value=${{ github.event.inputs.image_tag }},enable=${{ github.event_name == 'workflow_dispatch' }}
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix=,format=short
            type=ref,event=pr

      - name: ðŸ—ï¸ æž„å»ºå¹¶æŽ¨é€åŽç«¯é•œåƒ
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.backend
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          platforms: ${{ github.event.inputs.platforms || 'linux/amd64' }}
          cache-from: type=gha,scope=backend
          cache-to: type=gha,mode=max,scope=backend
          build-args: |
            NODE_OPTIONS=--max-old-space-size=1024

      - name: ðŸ” æ‰«æé•œåƒå®‰å…¨æ¼æ´ž
        if: github.event_name != 'pull_request'
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.BACKEND_IMAGE }}:latest
          format: 'sarif'
          output: 'trivy-backend-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: ðŸ“Š ä¸Šä¼ å®‰å…¨æ‰«æç»“æžœ
        if: github.event_name != 'pull_request'
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-backend-results.sarif'
          category: 'backend-image'

      - name: ðŸ“ˆ é•œåƒä¿¡æ¯æŠ¥å‘Š
        run: |
          echo "### ðŸ”§ åŽç«¯é•œåƒæž„å»ºå®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**é•œåƒæ ‡ç­¾:** \`${{ steps.meta.outputs.tags }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**å¹³å°:** \`${{ github.event.inputs.platforms || 'linux/amd64' }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**æž„å»ºID:** \`${{ steps.build.outputs.imageid }}\`" >> $GITHUB_STEP_SUMMARY
  # ==================== æž„å»ºå‰ç«¯é•œåƒ ====================
  build-frontend:
    name: ðŸŽ¨ æž„å»ºå‰ç«¯é•œåƒ
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      security-events: write

    steps:
      - name: ðŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ðŸ”§ è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            image=moby/buildkit:latest
            network=host

      - name: ðŸ” ç™»å½• GitHub Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ·ï¸ æå–é•œåƒå…ƒæ•°æ®
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.FRONTEND_IMAGE }}
          tags: |
            type=raw,value=latest,enable={{is_default_branch}}
            type=raw,value=${{ github.event.inputs.image_tag }},enable=${{ github.event_name == 'workflow_dispatch' }}
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix=,format=short
            type=ref,event=pr

      - name: ðŸ—ï¸ æž„å»ºå¹¶æŽ¨é€å‰ç«¯é•œåƒ
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.frontend
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          platforms: ${{ github.event.inputs.platforms || 'linux/amd64' }}
          cache-from: type=gha,scope=frontend
          cache-to: type=gha,mode=max,scope=frontend

      - name: ðŸ” æ‰«æé•œåƒå®‰å…¨æ¼æ´ž
        if: github.event_name != 'pull_request'
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.FRONTEND_IMAGE }}:latest
          format: 'sarif'
          output: 'trivy-frontend-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: ðŸ“Š ä¸Šä¼ å®‰å…¨æ‰«æç»“æžœ
        if: github.event_name != 'pull_request'
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-frontend-results.sarif'
          category: 'frontend-image'

      - name: ðŸ“ˆ é•œåƒä¿¡æ¯æŠ¥å‘Š
        run: |
          echo "### ðŸŽ¨ å‰ç«¯é•œåƒæž„å»ºå®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**é•œåƒæ ‡ç­¾:** \`${{ steps.meta.outputs.tags }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**å¹³å°:** \`${{ github.event.inputs.platforms || 'linux/amd64' }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**æž„å»ºID:** \`${{ steps.build.outputs.imageid }}\`" >> $GITHUB_STEP_SUMMARY

  # ==================== æž„å»ºå®ŒæˆæŠ¥å‘Š ====================
  report:
    name: ðŸ“Š æž„å»ºæŠ¥å‘Š
    runs-on: ubuntu-latest
    needs: [build-backend, build-frontend]
    if: always()

    steps:
      - name: ðŸ“‹ ç”Ÿæˆæž„å»ºæŠ¥å‘Š
        run: |
          echo "## ðŸš€ æ˜“æŠ¥é”€ Pro - Docker é•œåƒæž„å»ºæŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### æž„å»ºçŠ¶æ€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| ç»„ä»¶ | çŠ¶æ€ | é•œåƒ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”§ åŽç«¯ | ${{ needs.build-backend.result == 'success' && 'âœ… æˆåŠŸ' || 'âŒ å¤±è´¥' }} | \`${{ env.BACKEND_IMAGE }}:latest\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŽ¨ å‰ç«¯ | ${{ needs.build-frontend.result == 'success' && 'âœ… æˆåŠŸ' || 'âŒ å¤±è´¥' }} | \`${{ env.FRONTEND_IMAGE }}:latest\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.build-backend.result }}" == "success" && "${{ needs.build-frontend.result }}" == "success" ]]; then
            echo "### ðŸŽ‰ éƒ¨ç½²å‘½ä»¤" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```bash' >> $GITHUB_STEP_SUMMARY
            echo "# æ‹‰å–æœ€æ–°é•œåƒ" >> $GITHUB_STEP_SUMMARY
            echo "docker pull ${{ env.BACKEND_IMAGE }}:latest" >> $GITHUB_STEP_SUMMARY
            echo "docker pull ${{ env.FRONTEND_IMAGE }}:latest" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "# ä½¿ç”¨ docker-compose éƒ¨ç½²" >> $GITHUB_STEP_SUMMARY
            echo "docker-compose -f docker-compose.prod.yml pull" >> $GITHUB_STEP_SUMMARY
            echo "docker-compose -f docker-compose.prod.yml up -d" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“Š é•œåƒä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **ä»“åº“:** GitHub Container Registry (ghcr.io)" >> $GITHUB_STEP_SUMMARY
            echo "- **å¯è§æ€§:** æ ¹æ®ä»“åº“è®¾ç½®ï¼ˆé¦–æ¬¡éœ€åœ¨ Packages ä¸­è®¾ç½®ä¸º Publicï¼‰" >> $GITHUB_STEP_SUMMARY
            echo "- **å¹³å°:** linux/amd64" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âš ï¸ æž„å»ºå¤±è´¥" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "è¯·æŸ¥çœ‹æž„å»ºæ—¥å¿—ä»¥äº†è§£å¤±è´¥åŽŸå› ã€‚" >> $GITHUB_STEP_SUMMARY
          fi
